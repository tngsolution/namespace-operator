name: Bump Version

on:
  workflow_dispatch:
    inputs:
      preview:
        description: "Pre-release (-rc.x)"
        required: false
        default: "false"
      dry_run:
        description: "Dry run"
        required: false
        default: "false"
      base_branch:
        description: "Target branch for release PR"
        required: false
        default: "stable"

permissions:
  contents: write
  pull-requests: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout MAIN explicitly (important)
      # ------------------------------------------------------------
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # ------------------------------------------------------------
      # Install yq
      # ------------------------------------------------------------
      - name: Install tools
        run: sudo snap install yq

      # ------------------------------------------------------------
      # Ensure repo clean
      # ------------------------------------------------------------
      - name: Ensure repo clean
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Repository is dirty"
            exit 1
          fi

      # ------------------------------------------------------------
      # Detect bump level from commit messages
      # ------------------------------------------------------------
      - name: Detect bump level
        id: level
        run: |
          LAST_TAG=$(git tag --sort=-v:refname | head -n1 || echo "v0.0.0")
          RANGE="${LAST_TAG}..HEAD"
          LEVEL="patch"

          if git log $RANGE --pretty=%B | grep -q "BREAKING CHANGE\|feat!:"; then
            LEVEL="major"
          elif git log $RANGE --pretty=%B | grep -q "^feat:"; then
            LEVEL="minor"
          fi

          echo "level=$LEVEL" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Compute next version
      # ------------------------------------------------------------
      - name: Compute version
        id: version
        run: |
          LAST_TAG=$(git tag --sort=-v:refname | head -n1 || echo "v0.0.0")
          LAST_TAG=${LAST_TAG#v}

          IFS='.' read MAJOR MINOR PATCH <<< "$LAST_TAG"

          case "${{ steps.level.outputs.level }}" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR+1)); PATCH=0 ;;
            patch) PATCH=$((PATCH+1)) ;;
          esac

          BASE="$MAJOR.$MINOR.$PATCH"

          if [ "${{ inputs.preview }}" = "true" ]; then
            LAST_RC=$(git tag -l "v${BASE}-rc.*" | sort -V | tail -n1)
            RC=${LAST_RC##*.}
            RC=${RC:-0}
            VERSION="${BASE}-rc.$((RC+1))"
          else
            VERSION="$BASE"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------
      # Apply version changes (no manual commit)
      # ------------------------------------------------------------
      - name: Apply version
        if: inputs.dry_run != 'true'
        run: |
          VERSION=${{ steps.version.outputs.version }}

          yq -i '.version = "'$VERSION'"' manifests/charts/namespace-operator/Chart.yaml
          yq -i '.appVersion = "'$VERSION'"' manifests/charts/namespace-operator/Chart.yaml
          yq -i '.image.tag = "'$VERSION'"' manifests/charts/namespace-operator/values.yaml

          sed -i.bak "s/^VERSION := .*/VERSION := ${VERSION}/" Makefile
          rm -f Makefile.bak

      # ------------------------------------------------------------
      # Create PR (this creates branch + commit automatically)
      # ------------------------------------------------------------
      - name: Create Pull Request
        if: inputs.dry_run != 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: release/v${{ steps.version.outputs.version }}
          base: ${{ inputs.base_branch }}
          title: "chore(release): v${{ steps.version.outputs.version }}"
          commit-message: "chore(release): v${{ steps.version.outputs.version }}"
          body: |
            Automated version bump to v${{ steps.version.outputs.version }}

            - Source branch: main
            - Target branch: ${{ inputs.base_branch }}
            - Preview: ${{ inputs.preview }}